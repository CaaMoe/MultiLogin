
name: Update Contributors

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 1 * *"

jobs:
  update-contributors:
    runs-on: ubuntu-latest
    steps:

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0


      - name: Set up node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x

      - name: Fetch contributors
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="$GITHUB_REPOSITORY"
          node -e "
            const https = require('https');
            const repo = process.env.REPO;
            const options = {
              hostname: 'api.github.com',
              path: `/repos/${repo}/contributors`,
              port: 443,
              headers: {
                'User-Agent': 'Bot',
                'Authorization': `Bearer ${process.env.GITHUB_TOKEN}`
              }
            };
            https.get(options, (res) => {
              let data = '';
              res.on('data', (chunk) => { data += chunk; });
              res.on('end', () => {
                try {
                  const jsonArray = JSON.parse(data);
                  const names = jsonArray.filter(item => item.type === 'User').map(item => item.login);
                  require('fs').writeFileSync('contributors', names.join('\n'));
                } catch (error) {
                  console.error('Error processing contributors data:', error);
                  process.exit(1);
                }
              });
            }).on('error', (error) => {
              console.error('Error fetching contributors data:', error);
              process.exit(1);
            });
          "
      - name: Check for changes
        id: check_changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git fetch origin ${{ github.ref }}
          if ! git diff-index --quiet HEAD; then
            echo "New Contributors available, push now."
            git config user.name 'github-actions'
            git config user.email 'github-actions[bot]@users.noreply.github.com'
            git add -A
            git commit -am "Update contributors"
            git push "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git" HEAD:${GITHUB_REF#refs/heads/}
          else
            echo "No new contributors."
          fi
